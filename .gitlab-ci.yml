stages:
  - build
  - test
  - docker
  - deploy

variables:
  MAVEN_CLI_OPTS: "-s ../.m2/settings.xml --batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

cache:
  paths:
    - .m2/repository

####################
# ðŸ“Š Run SonarQube test analysis
####################
build_and_test:
  stage: build
  tags:
    - payment
  script:
    - echo "ðŸ”¨ Building all modules including Common"
    - for dir in Common Authentication-8083 Gateway-9090 Order-8082 Payment-8081 Product-8080; do
      echo "ðŸ“¦ Building $dir" &&
      cd $dir &&
      mvn $MAVEN_CLI_OPTS clean install &&
      cd .. ;
      done
  artifacts:
    paths:
      - Common/target/
      - Authentication-8083/target/
      - Gateway-9090/target/
      - Order-8082/target/
      - Payment-8081/target/
      - Product-8080/target/
    expire_in: 1h

######################
# ðŸ“Š SonarQube Analysis (after build)
######################
sonarqube_analysis:
  stage: test
  tags:
    - payment
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "ðŸ“Š Running SonarQube analysis"
    - mvn $MAVEN_CLI_OPTS sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
  dependencies:
    - build_and_test  # ðŸ‘ˆ ç¡®ä¿èƒ½æ‹¿åˆ°æž„å»ºå¥½çš„ target/ ç›®å½•
  only:
    - merge_requests
    - main
    - develop
####################
# ðŸ³ Docker æž„å»º & æŽ¨é€
####################
docker_build_push:
  stage: docker
  tags:
    - payment
  script:
    - echo "ðŸ” Logging into Docker registry"
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY

    - echo "ðŸ³ Building & pushing images with tag $DOCKER_TAG"
    - declare -A services=( \
      ["authentication-8083"]="Authentication-8083" \
      ["gateway-9090"]="Gateway-9090" \
      ["order-8082"]="Order-8082" \
      ["payment-8081"]="Payment-8081" \
      ["product-8080"]="Product-8080" \
      )
    - for service in "${!services[@]}"; do
      module=${services[$service]} ;
      dockerfile_name=Dockerfile_$(echo $service | cut -d'-' -f1 | awk '{print toupper(substr($0,0,1)) substr($0,2)}') ;
      jar_path="$module/target/$module-1.0-SNAPSHOT.jar" ;
      docker build -f Docker/$dockerfile_name --build-arg JAR_PATH=$jar_path -t $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$service:$DOCKER_TAG . ;
      docker push $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$service:$DOCKER_TAG ;
      done
  only:
    - main
  artifacts:
    paths:
      - Authentication-8083/target/
      - Gateway-9090/target/
      - Order-8082/target/
      - Payment-8081/target/
      - Product-8080/target/
    expire_in: 1h

####################
# ðŸš€ è¿œç¨‹éƒ¨ç½²
####################
deploy_to_server:
  stage: deploy
  tags:
    - payment
  before_script:
    - apt-get update && apt-get install -y openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸ“¦ Generating .env"
    - echo "IMAGE_TAG=$CI_COMMIT_SHORT_SHA" > Docker/.env

    - echo "ðŸ“¤ Sending files to server"
    - scp Docker/docker-compose.yml $DEPLOY_USER@$DEPLOY_HOST:/home/$DEPLOY_USER/app/
    - scp Docker/.env $DEPLOY_USER@$DEPLOY_HOST:/home/$DEPLOY_USER/app/

    - echo "ðŸš€ Remote docker-compose up"
    - ssh $DEPLOY_USER@$DEPLOY_HOST <<EOF
      cd /home/$DEPLOY_USER/app
      docker compose pull
      docker compose up -d
      EOF
  only:
    - main
