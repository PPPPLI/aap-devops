stages:
  - test
  - build_and_docker
  - deploy

variables:
  GIT_DEPTH: 0
  MAVEN_CLI_OPTS: "--batch-mode"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

cache:
  paths:
    - .m2/repository

######################
# ðŸ“Š SonarQube Analysis
######################f
test:
  image: maven:3.9-eclipse-temurin-17
  stage: test
  tags:
    - payment
  script:
    - echo "ðŸ“Š Rebuilding before Sonar analysis"
    - mvn $MAVEN_CLI_OPTS clean install -DskipTests
    - echo "ðŸ“Š Running SonarQube analysis"
    - mvn $MAVEN_CLI_OPTS clean install -DskipTests
    - mvn $MAVEN_CLI_OPTS sonar:sonar -Dsonar.projectKey=order-payment -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN
  only:
    - merge_requests
    - main
    - develop

#######################################
# ðŸ”¨ Build & ðŸ³ Docker æž„å»º & æŽ¨é€åˆå¹¶
#######################################
build_and_docker:
  image: docker:24.0.7
  stage: build_and_docker
  tags:
    - payment
  services:
    - name: docker:24.0.7-dind
      command: ["--insecure-registry=34.155.208.12:8080"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache openjdk17 maven
  script:
    - echo "ðŸ” Logging into Docker registry"
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY
    - echo "ðŸ”¨ Building JARs with Maven"
    - mvn $MAVEN_CLI_OPTS clean install -DskipTests
    - echo "ðŸ³ Building & pushing Docker images with tag $DOCKER_TAG"
    - |
      for dir in Authentication-8083 Gateway-9090 Order-8082 Payment-8081 Product-8080; do
        SERVICE=$(echo $dir | cut -d'-' -f1 | sed 's/Authentication/Auth/')
        IMAGE_NAME=$(echo $dir | tr '[:upper:]' '[:lower:]')
        JAR_FILE=$(find $dir/target -name "*.jar" | head -n 1)
        echo "ðŸš§ Building $IMAGE_NAME from $JAR_FILE"
        docker build -t $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$IMAGE_NAME:$DOCKER_TAG \
          --build-arg JAR_PATH=$JAR_FILE \
          -f Docker/Dockerfile_${SERVICE} .
        docker push $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$IMAGE_NAME:$DOCKER_TAG
      done
  only:
    - main

####################
# ðŸš€ è¿œç¨‹éƒ¨ç½²
####################
deploy_to_server:
  stage: deploy
  tags:
    - payment
  before_script:
    - apt-get update && apt-get install -y openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸ“¦ Generating .env"
    - echo "IMAGE_TAG=$CI_COMMIT_SHORT_SHA" > Docker/.env
    - echo "ðŸ“¤ Sending files to server"
    - ssh $DEPLOY_USER@$DEPLOY_HOST "mkdir -p /home/$DEPLOY_USER/app"
    - scp Docker/docker-compose.yml $DEPLOY_USER@$DEPLOY_HOST:/home/$DEPLOY_USER/app/
    - scp Docker/.env $DEPLOY_USER@$DEPLOY_HOST:/home/$DEPLOY_USER/app/
    - echo "ðŸš€ Remote docker-compose up"
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST <<EOF
        cd /home/$DEPLOY_USER/app
        docker compose pull
        docker compose up -d
      EOF
  only:
    - main
